<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JPYC投げ銭</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="module">
        import React from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        
        function TipPage() {
            const [recipientName, setRecipientName] = useState('');
            const [recipientAddress, setRecipientAddress] = useState('');
            const [avatarUrl, setAvatarUrl] = useState(null);
            const [connected, setConnected] = useState(false);
            const [userAddress, setUserAddress] = useState('');
            const [selectedToken, setSelectedToken] = useState('JPYC');
            const [amount, setAmount] = useState('');
            const [sending, setSending] = useState(false);
            
            const tokens = {
                JPYC: {
                    address: '0x6AE7Dfc73E0dDE2aa99ac063DcF7e8A63265108c',
                    decimals: 18,
                    name: 'JPY Coin',
                    description: '日本円ステーブルコイン (1 JPYC = 1円)'
                },
                USDC: {
                    address: '0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359',
                    decimals: 6,
                    name: 'USD Coin',
                    description: '米ドルステーブルコイン (1 USDC = 1ドル)'
                }
            };
            
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                
                // Check for short format (base64 encoded)
                const shortData = params.get('d');
                if (shortData) {
                    try {
                        const decoded = JSON.parse(atob(shortData));
                        setRecipientName(decoded.n);
                        setRecipientAddress(decoded.a);
                        if (decoded.k) {
                            const avatar = localStorage.getItem('avatar_' + decoded.k);
                            if (avatar) setAvatarUrl(avatar);
                        }
                        return;
                    } catch (e) {
                        console.error('Failed to decode short URL', e);
                    }
                }
                
                // Fallback to long format
                const name = params.get('name');
                const addr = params.get('address');
                const avatarKey = params.get('avatarKey');
                
                if (name) setRecipientName(name);
                if (addr) setRecipientAddress(addr);
                
                if (avatarKey) {
                    const avatar = localStorage.getItem('avatar_' + avatarKey);
                    if (avatar) setAvatarUrl(avatar);
                }
            }, []);
            
            const connectWallet = async () => {
                if (typeof window.ethereum !== 'undefined') {
                    try {
                        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                        setUserAddress(accounts[0]);
                        setConnected(true);
                        
                        // Switch to Polygon
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: '0x89' }],
                            });
                        } catch (switchError) {
                            if (switchError.code === 4902) {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: '0x89',
                                        chainName: 'Polygon Mainnet',
                                        nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                                        rpcUrls: ['https://polygon-rpc.com/'],
                                        blockExplorerUrls: ['https://polygonscan.com/']
                                    }]
                                });
                            }
                        }
                    } catch (error) {
                        alert('ウォレット接続に失敗しました: ' + error.message);
                    }
                } else {
                    alert('ウォレットがインストールされていません。MetaMask等のWeb3ウォレットをインストールしてください。');
                }
            };
            
            const sendTip = async () => {
                if (!connected) {
                    alert('ウォレットを接続してください');
                    return;
                }
                
                if (!amount || parseFloat(amount) <= 0) {
                    alert('金額を入力してください');
                    return;
                }
                
                setSending(true);
                
                try {
                    const token = tokens[selectedToken];
                    const amountWei = BigInt(Math.floor(parseFloat(amount) * Math.pow(10, token.decimals)));
                    
                    // ERC20 transfer function signature
                    const transferFunction = '0xa9059cbb';
                    const addressPadded = recipientAddress.slice(2).padStart(64, '0');
                    const amountHex = amountWei.toString(16).padStart(64, '0');
                    const data = transferFunction + addressPadded + amountHex;
                    
                    const txHash = await window.ethereum.request({
                        method: 'eth_sendTransaction',
                        params: [{
                            from: userAddress,
                            to: token.address,
                            data: data
                        }]
                    });
                    
                    alert('投げ銭を送りました！\\nトランザクションハッシュ: ' + txHash + '\\n\\nPolygonscanで確認: https://polygonscan.com/tx/' + txHash);
                    setAmount('');
                } catch (error) {
                    alert('送金に失敗しました: ' + error.message);
                } finally {
                    setSending(false);
                }
            };
            
            const getInitials = (name) => {
                return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            };
            
            return React.createElement('div', { className: 'min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 py-12 px-4' },
                React.createElement('div', { className: 'max-w-md mx-auto' },
                    React.createElement('div', { className: 'bg-white rounded-xl shadow-xl p-8 space-y-6' },
                        // Avatar
                        React.createElement('div', { className: 'flex justify-center' },
                            avatarUrl ?
                                React.createElement('img', {
                                    src: avatarUrl,
                                    alt: recipientName,
                                    className: 'w-24 h-24 rounded-full object-cover border-4 border-blue-500 shadow-lg'
                                }) :
                                React.createElement('div', {
                                    className: 'w-24 h-24 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white text-3xl font-bold shadow-lg'
                                }, getInitials(recipientName))
                        ),
                        
                        // Title
                        React.createElement('div', { className: 'text-center' },
                            React.createElement('h1', { className: 'text-2xl font-bold' }, recipientName),
                            React.createElement('p', { className: 'text-xs text-gray-500 mt-1 font-mono' }, 
                                recipientAddress ? recipientAddress.slice(0, 10) + '...' + recipientAddress.slice(-8) : ''
                            ),
                            React.createElement('p', { className: 'text-gray-500 mt-2' }, '暗号資産で投げ銭を送る'),
                            React.createElement('div', { className: 'inline-flex items-center gap-1 mt-2 px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium' },
                                React.createElement('svg', { className: 'w-3 h-3', fill: 'currentColor', viewBox: '0 0 24 24' },
                                    React.createElement('path', { d: 'M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5' })
                                ),
                                'Polygon Network'
                            )
                        ),
                        
                        // Wallet Connection
                        !connected ?
                            React.createElement('button', {
                                onClick: connectWallet,
                                className: 'w-full h-11 px-4 rounded-md bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors'
                            }, 'ウォレット接続') :
                            React.createElement('div', { className: 'p-3 bg-green-50 border border-green-200 rounded-lg text-center' },
                                React.createElement('span', { className: 'text-sm font-medium text-green-700' },
                                    '✓ ' + userAddress.slice(0, 6) + '...' + userAddress.slice(-4)
                                )
                            ),
                        
                        // Token Selection (Always visible)
                        React.createElement('div', { className: 'space-y-2' },
                            React.createElement('label', { className: 'text-sm font-medium' }, '通貨を選択'),
                            React.createElement('div', { className: 'grid grid-cols-2 gap-3' },
                                Object.keys(tokens).map(symbol =>
                                    React.createElement('button', {
                                        key: symbol,
                                        onClick: () => setSelectedToken(symbol),
                                        disabled: !connected,
                                        className: 'p-4 rounded-lg border-2 transition-all ' + (selectedToken === symbol ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300') + (!connected ? ' opacity-60 cursor-not-allowed' : '')
                                    },
                                        React.createElement('div', { className: 'font-semibold text-lg' }, symbol),
                                        React.createElement('div', { className: 'text-xs text-gray-500 mt-1' }, tokens[symbol].name)
                                    )
                                )
                            ),
                            React.createElement('p', { className: 'text-xs text-gray-500' }, tokens[selectedToken].description)
                        ),
                        
                        // Amount Selection (Always visible)
                        React.createElement('div', { className: 'space-y-2' },
                            React.createElement('label', { className: 'text-sm font-medium' }, '金額を選択'),
                            React.createElement('div', { className: 'grid grid-cols-3 gap-3 mb-3' },
                                [10, 50, 100].map(preset =>
                                    React.createElement('button', {
                                        key: preset,
                                        onClick: () => setAmount(preset.toString()),
                                        disabled: !connected,
                                        className: 'px-4 py-2 rounded-md border-2 transition-all ' + (amount === preset.toString() ? 'border-blue-500 bg-blue-600 text-white' : 'border-gray-300 hover:border-gray-400') + (!connected ? ' opacity-60 cursor-not-allowed' : '')
                                    }, preset + ' ' + selectedToken)
                                )
                            ),
                            React.createElement('input', {
                                type: 'number',
                                placeholder: 'カスタム金額を入力',
                                value: amount,
                                onChange: (e) => setAmount(e.target.value),
                                disabled: !connected,
                                className: 'w-full h-10 px-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500' + (!connected ? ' opacity-60 cursor-not-allowed bg-gray-50' : '')
                            })
                        ),
                        
                        // Send Button (Always visible)
                        React.createElement('button', {
                            onClick: sendTip,
                            disabled: !amount || sending,
                            className: 'w-full h-11 px-4 rounded-md bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed'
                        }, sending ? '送信中...' : '投げ銭を送る'),
                        
                        // Footer
                        React.createElement('div', { className: 'text-center text-sm text-gray-500 pt-4 border-t' },
                            React.createElement('p', null, 'Polygon Mainnet上で動作しています'),
                            React.createElement('p', { className: 'mt-2' },
                                React.createElement('a', {
                                    href: 'https://github.com/5Y1U5/jpyc',
                                    target: '_blank',
                                    className: 'text-blue-600 hover:underline'
                                }, 'GitHub: 5Y1U5/jpyc')
                            )
                        )
                    )
                )
            );
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(TipPage));
    </script>
</body>
</html>
