<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JPYC投げ銭システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="module">
        import React from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        
        // Main App Component
        function App() {
            const [page, setPage] = useState('home');
            
            // Check if we're on the tip page
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                if (params.get('name') && params.get('address')) {
                    setPage('tip');
                }
            }, []);
            
            if (page === 'tip') {
                return React.createElement(TipPage);
            }
            
            return React.createElement(GeneratorPage);
        }
        
        // Generator Page Component
        function GeneratorPage() {
            const [name, setName] = useState('');
            const [address, setAddress] = useState('');
            const [avatarPreview, setAvatarPreview] = useState(null);
            const [embedCode, setEmbedCode] = useState('');
            const [directUrl, setDirectUrl] = useState('');
            const [shortUrl, setShortUrl] = useState('');
            const [qrCodeUrl, setQrCodeUrl] = useState('');
            
            const handleImageUpload = (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = () => {
                    setAvatarPreview(reader.result);
                    if (address) {
                        localStorage.setItem('avatar_' + address.toLowerCase(), reader.result);
                    }
                };
                reader.readAsDataURL(file);
            };
            
            const generateCode = () => {
                if (!name || !address) {
                    alert('表示名とウォレットアドレスを入力してください');
                    return;
                }
                
                if (avatarPreview && address) {
                    localStorage.setItem('avatar_' + address.toLowerCase(), avatarPreview);
                }
                
                const baseUrl = window.location.origin;
                
                // Create short parameters using base64 encoding
                const shortData = btoa(JSON.stringify({ n: name, a: address, k: address.toLowerCase() }));
                const tipUrl = baseUrl + '/tip.html?d=' + shortData;
                
                const iframe = '<iframe src="' + tipUrl + '" width="100%" height="600" style="border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></iframe>';
                
                // Generate QR code using API
                const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(tipUrl);
                
                setEmbedCode(iframe);
                setDirectUrl(tipUrl);
                setShortUrl(tipUrl.replace(baseUrl, ''));
                setQrCodeUrl(qrUrl);
            };
            
            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text).then(() => {
                    alert('コピーしました');
                });
            };
            
            const downloadQR = () => {
                const link = document.createElement('a');
                link.href = qrCodeUrl;
                link.download = 'jpyc-tip-qr-' + name + '.png';
                link.click();
            };
            
            return React.createElement('div', { className: 'min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 py-12 px-4' },
                React.createElement('div', { className: 'max-w-4xl mx-auto space-y-8' },
                    // Header
                    React.createElement('div', { className: 'text-center space-y-4' },
                        React.createElement('h1', { className: 'text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent' },
                            'JPYC投げ銭システム'
                        ),
                        React.createElement('p', { className: 'text-gray-600 text-lg' },
                            '暗号資産で簡単に投げ銭を受け取れる埋め込みコードを生成'
                        )
                    ),
                    
                    // Input Form
                    React.createElement('div', { className: 'bg-white rounded-lg shadow-sm border p-6 space-y-6' },
                        React.createElement('div', null,
                            React.createElement('h2', { className: 'text-2xl font-semibold mb-2' }, '受取人情報の入力'),
                            React.createElement('p', { className: 'text-sm text-gray-500' }, '投げ銭を受け取る方の情報を入力してください')
                        ),
                        
                        // Name Input
                        React.createElement('div', { className: 'space-y-2' },
                            React.createElement('label', { className: 'text-sm font-medium' },
                                '表示名 ',
                                React.createElement('span', { className: 'text-red-500' }, '*')
                            ),
                            React.createElement('input', {
                                type: 'text',
                                placeholder: '例: クリエイター太郎',
                                value: name,
                                onChange: (e) => setName(e.target.value),
                                maxLength: 50,
                                className: 'flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500'
                            }),
                            React.createElement('p', { className: 'text-xs text-gray-500' },
                                '投げ銭ページに表示される名前（最大50文字）'
                            )
                        ),
                        
                        // Address Input
                        React.createElement('div', { className: 'space-y-2' },
                            React.createElement('label', { className: 'text-sm font-medium' },
                                'ウォレットアドレス ',
                                React.createElement('span', { className: 'text-red-500' }, '*')
                            ),
                            React.createElement('input', {
                                type: 'text',
                                placeholder: '0x...',
                                value: address,
                                onChange: (e) => setAddress(e.target.value),
                                className: 'flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500'
                            }),
                            React.createElement('p', { className: 'text-xs text-gray-500' },
                                'Polygon Mainnetのウォレットアドレス'
                            )
                        ),
                        
                        // Avatar Upload
                        React.createElement('div', { className: 'space-y-2' },
                            React.createElement('label', { className: 'text-sm font-medium' }, 'アバター画像（任意）'),
                            React.createElement('div', { className: 'flex items-center gap-4' },
                                React.createElement('input', {
                                    type: 'file',
                                    accept: 'image/jpeg,image/png,image/gif,image/webp',
                                    onChange: handleImageUpload,
                                    className: 'flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm'
                                }),
                                avatarPreview && React.createElement('img', {
                                    src: avatarPreview,
                                    className: 'w-16 h-16 rounded-full object-cover border-2 border-gray-200'
                                })
                            )
                        ),
                        
                        // Generate Button
                        React.createElement('button', {
                            onClick: generateCode,
                            className: 'w-full h-11 px-8 rounded-md bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors'
                        }, '埋め込みコードを生成')
                    ),
                    
                    // Generated Code
                    embedCode && React.createElement('div', { className: 'bg-white rounded-lg shadow-sm border p-6 space-y-6' },
                        React.createElement('div', null,
                            React.createElement('h2', { className: 'text-2xl font-semibold mb-2' }, '生成された埋め込みコード'),
                            React.createElement('p', { className: 'text-sm text-gray-500' }, '以下のコードをWebサイトに貼り付けてください')
                        ),
                        
                        // Embed Code
                        React.createElement('div', { className: 'space-y-2' },
                            React.createElement('div', { className: 'flex items-center justify-between mb-2' },
                                React.createElement('label', { className: 'text-sm font-medium' }, '埋め込みコード（iframe）'),
                                React.createElement('button', {
                                    onClick: () => copyToClipboard(embedCode),
                                    className: 'px-3 py-1 text-sm rounded-md border border-gray-300 hover:bg-gray-50'
                                }, 'コピー')
                            ),
                            React.createElement('textarea', {
                                readOnly: true,
                                value: embedCode,
                                className: 'w-full h-24 p-3 text-sm font-mono bg-gray-50 border border-gray-200 rounded-md resize-none'
                            })
                        ),
                        
                        // Short URL
                        React.createElement('div', { className: 'space-y-2' },
                            React.createElement('div', { className: 'flex items-center justify-between mb-2' },
                                React.createElement('label', { className: 'text-sm font-medium' }, '短縮URL（SNS共有用）'),
                                React.createElement('div', { className: 'flex gap-2' },
                                    React.createElement('button', {
                                        onClick: () => window.open(directUrl, '_blank'),
                                        className: 'px-3 py-1 text-sm rounded-md border border-gray-300 hover:bg-gray-50'
                                    }, 'プレビュー'),
                                    React.createElement('button', {
                                        onClick: () => copyToClipboard(directUrl),
                                        className: 'px-3 py-1 text-sm rounded-md border border-gray-300 hover:bg-gray-50'
                                    }, 'コピー')
                                )
                            ),
                            React.createElement('input', {
                                readOnly: true,
                                value: directUrl,
                                className: 'w-full h-10 px-3 py-2 text-sm font-mono bg-gray-50 border border-gray-200 rounded-md'
                            }),
                            React.createElement('p', { className: 'text-xs text-gray-500' }, 
                                '短縮形式: ' + shortUrl
                            )
                        ),
                        
                        // QR Code
                        React.createElement('div', { className: 'space-y-2' },
                            React.createElement('div', { className: 'flex items-center justify-between mb-2' },
                                React.createElement('label', { className: 'text-sm font-medium' }, 'QRコード'),
                                React.createElement('button', {
                                    onClick: downloadQR,
                                    className: 'px-3 py-1 text-sm rounded-md border border-gray-300 hover:bg-gray-50'
                                }, 'ダウンロード')
                            ),
                            React.createElement('div', { className: 'flex justify-center p-4 bg-white border border-gray-200 rounded-lg' },
                                React.createElement('img', {
                                    src: qrCodeUrl,
                                    alt: 'QR Code',
                                    className: 'w-48 h-48'
                                })
                            ),
                            React.createElement('p', { className: 'text-xs text-gray-500 text-center' }, 
                                'スマートフォンで読み取ると投げ銭ページを開けます'
                            )
                        )
                    )
                )
            );
        }
        
        // Tip Page Component
        function TipPage() {
            const [recipientName, setRecipientName] = useState('');
            const [recipientAddress, setRecipientAddress] = useState('');
            const [avatarUrl, setAvatarUrl] = useState(null);
            const [connected, setConnected] = useState(false);
            const [userAddress, setUserAddress] = useState('');
            
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                
                // Check for short format (base64 encoded)
                const shortData = params.get('d');
                if (shortData) {
                    try {
                        const decoded = JSON.parse(atob(shortData));
                        setRecipientName(decoded.n);
                        setRecipientAddress(decoded.a);
                        if (decoded.k) {
                            const avatar = localStorage.getItem('avatar_' + decoded.k);
                            if (avatar) setAvatarUrl(avatar);
                        }
                        return;
                    } catch (e) {
                        console.error('Failed to decode short URL', e);
                    }
                }
                
                // Fallback to long format
                const name = params.get('name');
                const addr = params.get('address');
                const avatarKey = params.get('avatarKey');
                
                if (name) setRecipientName(name);
                if (addr) setRecipientAddress(addr);
                
                if (avatarKey) {
                    const avatar = localStorage.getItem('avatar_' + avatarKey);
                    if (avatar) setAvatarUrl(avatar);
                }
            }, []);
            
            const connectWallet = async () => {
                if (typeof window.ethereum !== 'undefined') {
                    try {
                        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                        setUserAddress(accounts[0]);
                        setConnected(true);
                        
                        // Switch to Polygon
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: '0x89' }],
                            });
                        } catch (switchError) {
                            if (switchError.code === 4902) {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: '0x89',
                                        chainName: 'Polygon Mainnet',
                                        nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                                        rpcUrls: ['https://polygon-rpc.com/'],
                                        blockExplorerUrls: ['https://polygonscan.com/']
                                    }]
                                });
                            }
                        }
                    } catch (error) {
                        alert('ウォレット接続に失敗しました');
                    }
                } else {
                    alert('ウォレットがインストールされていません。MetaMask等のWeb3ウォレットをインストールしてください。');
                }
            };
            
            const getInitials = (name) => {
                return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            };
            
            return React.createElement('div', { className: 'min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 py-12 px-4' },
                React.createElement('div', { className: 'max-w-md mx-auto' },
                    React.createElement('div', { className: 'bg-white rounded-xl shadow-xl p-8 space-y-6' },
                        // Avatar
                        React.createElement('div', { className: 'flex justify-center' },
                            avatarUrl ?
                                React.createElement('img', {
                                    src: avatarUrl,
                                    alt: recipientName,
                                    className: 'w-24 h-24 rounded-full object-cover border-4 border-blue-500 shadow-lg'
                                }) :
                                React.createElement('div', {
                                    className: 'w-24 h-24 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white text-3xl font-bold shadow-lg'
                                }, getInitials(recipientName))
                        ),
                        
                        // Title
                        React.createElement('div', { className: 'text-center' },
                            React.createElement('h1', { className: 'text-2xl font-bold' }, recipientName),
                            React.createElement('p', { className: 'text-xs text-gray-500 mt-1 font-mono' }, 
                                recipientAddress ? recipientAddress.slice(0, 10) + '...' + recipientAddress.slice(-8) : ''
                            ),
                            React.createElement('p', { className: 'text-gray-500 mt-2' }, '暗号資産で投げ銭を送る'),
                            React.createElement('div', { className: 'inline-flex items-center gap-1 mt-2 px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium' },
                                React.createElement('svg', { className: 'w-3 h-3', fill: 'currentColor', viewBox: '0 0 24 24' },
                                    React.createElement('path', { d: 'M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5' })
                                ),
                                'Polygon Network'
                            )
                        ),
                        
                        // Wallet Connection
                        !connected ?
                            React.createElement('button', {
                                onClick: connectWallet,
                                className: 'w-full h-11 px-4 rounded-md bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors'
                            }, 'ウォレット接続') :
                            React.createElement('div', { className: 'p-3 bg-green-50 border border-green-200 rounded-lg text-center' },
                                React.createElement('span', { className: 'text-sm font-medium text-green-700' },
                                    userAddress.slice(0, 6) + '...' + userAddress.slice(-4)
                                )
                            ),
                        
                        // Info
                        React.createElement('div', { className: 'bg-blue-50 rounded-lg p-4 space-y-2' },
                            React.createElement('h3', { className: 'font-semibold text-blue-900' }, '対応トークン'),
                            React.createElement('ul', { className: 'text-sm text-blue-800 space-y-1' },
                                React.createElement('li', null, '• JPYC (日本円ステーブルコイン)'),
                                React.createElement('li', null, '• USDC (米ドルステーブルコイン)')
                            )
                        ),
                        
                        // Instructions
                        React.createElement('div', { className: 'text-center text-sm text-gray-500 pt-4 border-t' },
                            React.createElement('p', null, 'Polygon Mainnet上で動作しています'),
                            React.createElement('p', { className: 'mt-2' },
                                React.createElement('a', {
                                    href: 'https://github.com/5Y1U5/jpyc',
                                    target: '_blank',
                                    className: 'text-blue-600 hover:underline'
                                }, 'GitHub: 5Y1U5/jpyc')
                            )
                        )
                    )
                )
            );
        }
        
        // Render App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
