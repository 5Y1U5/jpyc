<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JPYC投げ銭システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="module">
        import React from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        
        // Generator Page Component
        function GeneratorPage() {
            const [name, setName] = useState('');
            const [address, setAddress] = useState('');
            const [avatarUrl, setAvatarUrl] = useState('');
            const [embedCode, setEmbedCode] = useState('');
            const [directUrl, setDirectUrl] = useState('');
            const [shortUrl, setShortUrl] = useState('');
            const [qrCodeUrl, setQrCodeUrl] = useState('');
            
            const handleAvatarUrlChange = (e) => {
                const url = e.target.value;
                setAvatarUrl(url);
            };
            
            const generateShortId = () => {
                // Generate a short random ID (6 characters)
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let result = '';
                for (let i = 0; i < 6; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            };
            
            const generateCode = () => {
                if (!name || !address) {
                    alert('表示名とウォレットアドレスを入力してください');
                    return;
                }
                
                const baseUrl = window.location.origin;
                
                // Create short parameters using base64 encoding
                // Include avatar URL if available
                const shortData = btoa(JSON.stringify({ 
                    n: name, 
                    a: address, 
                    img: avatarUrl || null 
                }));
                
                // Generate a truly short URL using random ID
                const shortId = generateShortId();
                const tipUrl = baseUrl + '/tip.html?d=' + shortData;
                const shortTipUrl = baseUrl + '/t/' + shortId;
                
                // Store mapping in localStorage (for demo purposes)
                // In production, this would be stored in Cloudflare KV
                localStorage.setItem('shorturl_' + shortId, shortData);
                
                const iframe = '<iframe src="' + tipUrl + '" width="100%" height="600" style="border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></iframe>';
                
                // Generate QR code using short URL for better scanning
                const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(shortTipUrl);
                
                setEmbedCode(iframe);
                setDirectUrl(tipUrl);
                setShortUrl(shortTipUrl);
                setQrCodeUrl(qrUrl);
            };
            
            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text).then(() => {
                    alert('コピーしました');
                });
            };
            
            const downloadQR = () => {
                const link = document.createElement('a');
                link.href = qrCodeUrl;
                link.download = 'jpyc-tip-qr-' + name + '.png';
                link.click();
            };
            
            return React.createElement('div', { className: 'min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 py-12 px-4' },
                React.createElement('div', { className: 'max-w-4xl mx-auto space-y-8' },
                    // Header
                    React.createElement('div', { className: 'text-center space-y-4' },
                        React.createElement('h1', { className: 'text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent' },
                            'JPYC投げ銭システム'
                        ),
                        React.createElement('p', { className: 'text-gray-600 text-lg' },
                            '暗号資産で簡単に投げ銭を受け取れる埋め込みコードを生成'
                        )
                    ),
                    
                    // Input Form
                    React.createElement('div', { className: 'bg-white rounded-lg shadow-sm border p-6 space-y-6' },
                        React.createElement('div', null,
                            React.createElement('h2', { className: 'text-2xl font-semibold mb-2' }, '受取人情報の入力'),
                            React.createElement('p', { className: 'text-sm text-gray-500' }, '投げ銭を受け取る方の情報を入力してください')
                        ),
                        
                        // Name Input
                        React.createElement('div', { className: 'space-y-2' },
                            React.createElement('label', { className: 'text-sm font-medium' },
                                '表示名 ',
                                React.createElement('span', { className: 'text-red-500' }, '*')
                            ),
                            React.createElement('input', {
                                type: 'text',
                                placeholder: '例: クリエイター太郎',
                                value: name,
                                onChange: (e) => setName(e.target.value),
                                maxLength: 50,
                                className: 'flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500'
                            }),
                            React.createElement('p', { className: 'text-xs text-gray-500' },
                                '投げ銭ページに表示される名前（最大50文字）'
                            )
                        ),
                        
                        // Address Input
                        React.createElement('div', { className: 'space-y-2' },
                            React.createElement('label', { className: 'text-sm font-medium' },
                                'ウォレットアドレス ',
                                React.createElement('span', { className: 'text-red-500' }, '*')
                            ),
                            React.createElement('input', {
                                type: 'text',
                                placeholder: '0x...',
                                value: address,
                                onChange: (e) => setAddress(e.target.value),
                                className: 'flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500'
                            }),
                            React.createElement('p', { className: 'text-xs text-gray-500' },
                                'Polygon Mainnetのウォレットアドレス'
                            )
                        ),
                        
                        // Avatar URL Input
                        React.createElement('div', { className: 'space-y-2' },
                            React.createElement('label', { className: 'text-sm font-medium' }, 'アバター画像URL（任意）'),
                            React.createElement('input', {
                                type: 'url',
                                placeholder: 'https://example.com/avatar.jpg',
                                value: avatarUrl,
                                onChange: handleAvatarUrlChange,
                                className: 'flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500'
                            }),
                            avatarUrl && React.createElement('div', { className: 'flex items-center gap-3' },
                                React.createElement('img', {
                                    src: avatarUrl,
                                    alt: 'Preview',
                                    className: 'w-16 h-16 rounded-full object-cover border-2 border-gray-200',
                                    onError: (e) => { e.target.style.display = 'none'; }
                                }),
                                React.createElement('p', { className: 'text-xs text-green-600' }, '✓ プレビュー表示')
                            ),
                            React.createElement('p', { className: 'text-xs text-gray-500' },
                                '画像ホスティングサービス（imgur.com、Gravatar等）のURLを入力'
                            )
                        ),
                        
                        // Generate Button
                        React.createElement('button', {
                            onClick: generateCode,
                            className: 'w-full h-11 px-8 rounded-md bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors'
                        }, '埋め込みコードを生成')
                    ),
                    
                    // Generated Code
                    embedCode && React.createElement('div', { className: 'bg-white rounded-lg shadow-sm border p-6 space-y-6' },
                        React.createElement('div', null,
                            React.createElement('h2', { className: 'text-2xl font-semibold mb-2' }, '生成された埋め込みコード'),
                            React.createElement('p', { className: 'text-sm text-gray-500' }, '以下のコードをWebサイトに貼り付けてください')
                        ),
                        
                        // Embed Code
                        React.createElement('div', { className: 'space-y-2' },
                            React.createElement('div', { className: 'flex items-center justify-between mb-2' },
                                React.createElement('label', { className: 'text-sm font-medium' }, '埋め込みコード（iframe）'),
                                React.createElement('button', {
                                    onClick: () => copyToClipboard(embedCode),
                                    className: 'px-3 py-1 text-sm rounded-md border border-gray-300 hover:bg-gray-50'
                                }, 'コピー')
                            ),
                            React.createElement('textarea', {
                                readOnly: true,
                                value: embedCode,
                                className: 'w-full h-24 p-3 text-sm font-mono bg-gray-50 border border-gray-200 rounded-md resize-none'
                            })
                        ),
                        
                        // Direct URL
                        React.createElement('div', { className: 'space-y-2' },
                            React.createElement('div', { className: 'flex items-center justify-between mb-2' },
                                React.createElement('label', { className: 'text-sm font-medium' }, 'ダイレクトURL'),
                                React.createElement('div', { className: 'flex gap-2' },
                                    React.createElement('button', {
                                        onClick: () => window.open(directUrl, '_blank'),
                                        className: 'px-3 py-1 text-sm rounded-md border border-gray-300 hover:bg-gray-50'
                                    }, 'プレビュー'),
                                    React.createElement('button', {
                                        onClick: () => copyToClipboard(directUrl),
                                        className: 'px-3 py-1 text-sm rounded-md border border-gray-300 hover:bg-gray-50'
                                    }, 'コピー')
                                )
                            ),
                            React.createElement('input', {
                                readOnly: true,
                                value: directUrl,
                                className: 'w-full h-10 px-3 py-2 text-sm font-mono bg-gray-50 border border-gray-200 rounded-md'
                            })
                        ),
                        
                        // Short URL
                        React.createElement('div', { className: 'space-y-2' },
                            React.createElement('div', { className: 'flex items-center justify-between mb-2' },
                                React.createElement('label', { className: 'text-sm font-medium' }, 
                                    '短縮URL ',
                                    React.createElement('span', { className: 'px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded font-normal' }, '推奨')
                                ),
                                React.createElement('div', { className: 'flex gap-2' },
                                    React.createElement('button', {
                                        onClick: () => window.open(shortUrl, '_blank'),
                                        className: 'px-3 py-1 text-sm rounded-md border border-gray-300 hover:bg-gray-50'
                                    }, 'プレビュー'),
                                    React.createElement('button', {
                                        onClick: () => copyToClipboard(shortUrl),
                                        className: 'px-3 py-1 text-sm rounded-md bg-blue-600 text-white hover:bg-blue-700'
                                    }, 'コピー')
                                )
                            ),
                            React.createElement('input', {
                                readOnly: true,
                                value: shortUrl,
                                className: 'w-full h-10 px-3 py-2 text-sm font-mono bg-green-50 border border-green-300 rounded-md font-semibold'
                            }),
                            React.createElement('p', { className: 'text-xs text-gray-500' }, 
                                '✨ SNS共有やQRコードに最適な短縮URL'
                            )
                        ),
                        
                        // QR Code
                        React.createElement('div', { className: 'space-y-2' },
                            React.createElement('div', { className: 'flex items-center justify-between mb-2' },
                                React.createElement('label', { className: 'text-sm font-medium' }, 'QRコード'),
                                React.createElement('button', {
                                    onClick: downloadQR,
                                    className: 'px-3 py-1 text-sm rounded-md border border-gray-300 hover:bg-gray-50'
                                }, 'ダウンロード')
                            ),
                            React.createElement('div', { className: 'flex justify-center p-4 bg-white border border-gray-200 rounded-lg' },
                                React.createElement('img', {
                                    src: qrCodeUrl,
                                    alt: 'QR Code',
                                    className: 'w-48 h-48'
                                })
                            ),
                            React.createElement('p', { className: 'text-xs text-gray-500 text-center' }, 
                                'スマートフォンで読み取ると投げ銭ページを開けます'
                            )
                        )
                    )
                )
            );
        }
        
        // Render App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(GeneratorPage));
    </script>
</body>
</html>
